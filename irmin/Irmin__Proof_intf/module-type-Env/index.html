<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Env (irmin.Irmin__Proof_intf.Env)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../index.html">irmin</a> &#x00BB; <a href="../index.html">Irmin__Proof_intf</a> &#x00BB; Env</nav><h1>Module type <code>Irmin__Proof_intf.Env</code></h1><p>Environment that tracks side effects during the production/consumption of proofs.</p><h2 id="the-merkle-proof-construction-algorithm"><a href="#the-merkle-proof-construction-algorithm" class="anchor"></a>The merkle proof construction algorithm</h2><p>This description assumes that the large nodes are represented by the backend as a tree structure (i.e. inodes). There are 4 distinct phases when working with Irmin's merkle proofs: <code>Produce | Serialise | Deserialise | Consume</code>.</p><h3 id="produce"><a href="#produce" class="anchor"></a><code>Produce</code></h3><p>In this phase the Irmin user builds an <code>after</code> tree from a <code>before</code> tree that has been setup with an <code>Env</code> that records every backend reads into two hash tables.</p><p>During the next phase (i.e. <code>Serialise</code>) the cleared <code>before</code> tree will be traversed from root to stems only following the paths that are referenced in <code>Env</code>.</p><p>In practice <code>Env</code> doesn't exactly records the reads, it keeps track of all the <code>hash -&gt; backend node</code> and <code>hash -&gt; backend contents</code> mappings that are directly output of the backend stores through <code>P.Node.find</code> and <code>P.Contents.find</code>. This is obviously enough to remember the contents, the nodes and the inodes tips, but the inner inodes are not directly referenced in the hash tables.</p><p>The inner inodes are in fact referenced in their inode tip which is itself referenced in <code>Env</code>'s hash tables. Since an inode shares its lazy pointers with the inodes derived from it, even the inner inodes that are loaded from the derived tips will be available from the original inode tip.</p><h3 id="serialise"><a href="#serialise" class="anchor"></a><code>Serialise</code></h3><p>In this phase the <code>Env</code> contains everything necessary for the computation of a merkle proof from a cleared <code>before</code>. The <code>Env</code> now affects <code>Node.cached_value</code> and <code>Contents.cached_value</code> allowing for the discovery of the cached closure.</p><h3 id="deserialise"><a href="#deserialise" class="anchor"></a><code>Deserialise</code></h3><p>In this phase the <code>Env</code> is filled by recursively destructing the proof and filling it before the <code>Consume</code> phase.</p><h3 id="consume"><a href="#consume" class="anchor"></a><code>Consume</code></h3><p>In this last phase the <code>Env</code> is again made accessible through <code>Node.cached_value</code> and <code>Contents.cached_value</code>, making it possible for the user to reference by <code>hash</code> everything that was contained in the proof.</p><nav class="toc"><ul><li><a href="#construction-of-envs">Construction of envs</a></li><li><a href="#modes">Modes</a></li><li><a href="#in/out-backend-objects-with-tree">In/out backend objects with <code>Tree</code></a></li></ul></nav></header><dl><dt class="spec type" id="type-kind"><a href="#type-kind" class="anchor"></a><code><span class="keyword">type</span> kind</code><code> = </code><table class="variant"><tr id="type-kind.Set" class="anchored"><td class="def constructor"><a href="#type-kind.Set" class="anchor"></a><code>| </code><code><span class="constructor">Set</span></code></td></tr><tr id="type-kind.Stream" class="anchored"><td class="def constructor"><a href="#type-kind.Stream" class="anchor"></a><code>| </code><code><span class="constructor">Stream</span></code></td></tr></table></dt><dt class="spec type" id="type-mode"><a href="#type-mode" class="anchor"></a><code><span class="keyword">type</span> mode</code><code> = </code><table class="variant"><tr id="type-mode.Produce" class="anchored"><td class="def constructor"><a href="#type-mode.Produce" class="anchor"></a><code>| </code><code><span class="constructor">Produce</span></code></td></tr><tr id="type-mode.Serialise" class="anchored"><td class="def constructor"><a href="#type-mode.Serialise" class="anchor"></a><code>| </code><code><span class="constructor">Serialise</span></code></td></tr><tr id="type-mode.Deserialise" class="anchored"><td class="def constructor"><a href="#type-mode.Deserialise" class="anchor"></a><code>| </code><code><span class="constructor">Deserialise</span></code></td></tr><tr id="type-mode.Consume" class="anchored"><td class="def constructor"><a href="#type-mode.Consume" class="anchor"></a><code>| </code><code><span class="constructor">Consume</span></code></td></tr></table></dt><dt class="spec type" id="type-v"><a href="#type-v" class="anchor"></a><code><span class="keyword">type</span> v</code></dt><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> t</code></dt><dt class="spec type" id="type-hash"><a href="#type-hash" class="anchor"></a><code><span class="keyword">type</span> hash</code></dt><dt class="spec type" id="type-node"><a href="#type-node" class="anchor"></a><code><span class="keyword">type</span> node</code></dt><dt class="spec type" id="type-contents"><a href="#type-contents" class="anchor"></a><code><span class="keyword">type</span> contents</code></dt><dt class="spec type" id="type-stream"><a href="#type-stream" class="anchor"></a><code><span class="keyword">type</span> stream</code></dt></dl><dl><dt class="spec value" id="val-t"><a href="#val-t" class="anchor"></a><code><span class="keyword">val</span> t : <span><a href="index.html#type-t">t</a> <a href="../../Irmin__/index.html#module-Type">Irmin__.Type</a>.ty</span></code></dt><dt class="spec value" id="val-is_empty"><a href="#val-is_empty" class="anchor"></a><code><span class="keyword">val</span> is_empty : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> bool</code></dt></dl><section><header><h3 id="construction-of-envs"><a href="#construction-of-envs" class="anchor"></a>Construction of envs</h3></header><dl><dt class="spec value" id="val-empty"><a href="#val-empty" class="anchor"></a><code><span class="keyword">val</span> empty : unit <span>&#45;&gt;</span> <a href="index.html#type-t">t</a></code></dt><dt class="spec value" id="val-copy"><a href="#val-copy" class="anchor"></a><code><span class="keyword">val</span> copy : <span>into:<a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> unit</code></dt></dl></section><section><header><h3 id="modes"><a href="#modes" class="anchor"></a>Modes</h3></header><dl><dt class="spec value" id="val-mode"><a href="#val-mode" class="anchor"></a><code><span class="keyword">val</span> mode : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span><a href="index.html#type-mode">mode</a> option</span></code></dt><dt class="spec value" id="val-set_mode"><a href="#val-set_mode" class="anchor"></a><code><span class="keyword">val</span> set_mode : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-kind">kind</a> <span>&#45;&gt;</span> <a href="index.html#type-mode">mode</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-with_set_produce"><a href="#val-with_set_produce" class="anchor"></a><code><span class="keyword">val</span> with_set_produce : <span>(<a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>start_serialise:<span>(unit <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dt class="spec value" id="val-with_set_consume"><a href="#val-with_set_consume" class="anchor"></a><code><span class="keyword">val</span> with_set_consume : <span>(<a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>stop_deserialise:<span>(unit <span>&#45;&gt;</span> unit)</span></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dt class="spec value" id="val-with_stream_produce"><a href="#val-with_stream_produce" class="anchor"></a><code><span class="keyword">val</span> with_stream_produce : <span>(<a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>to_stream:<span>(unit <span>&#45;&gt;</span> <a href="index.html#type-stream">stream</a>)</span></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dt class="spec value" id="val-with_stream_consume"><a href="#val-with_stream_consume" class="anchor"></a><code><span class="keyword">val</span> with_stream_consume : <a href="index.html#type-stream">stream</a> <span>&#45;&gt;</span> <span>(<a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <span>is_empty:<span>(unit <span>&#45;&gt;</span> bool)</span></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt></dl></section><section><header><h3 id="in/out-backend-objects-with-tree"><a href="#in/out-backend-objects-with-tree" class="anchor"></a>In/out backend objects with <code>Tree</code></h3></header><dl><dt class="spec value" id="val-add_contents_from_store"><a href="#val-add_contents_from_store" class="anchor"></a><code><span class="keyword">val</span> add_contents_from_store : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-hash">hash</a> <span>&#45;&gt;</span> <a href="index.html#type-contents">contents</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-add_node_from_store"><a href="#val-add_node_from_store" class="anchor"></a><code><span class="keyword">val</span> add_node_from_store : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-hash">hash</a> <span>&#45;&gt;</span> <a href="index.html#type-node">node</a> <span>&#45;&gt;</span> <a href="index.html#type-node">node</a></code></dt><dd><p><code>add_node_from_store</code> returns a <code>node</code> and not <code>unit</code> because <code>Env</code> may take the opportunity to wrap the input node in <code>Node.Val.with_handler</code>.</p></dd></dl><dl><dt class="spec value" id="val-add_contents_from_proof"><a href="#val-add_contents_from_proof" class="anchor"></a><code><span class="keyword">val</span> add_contents_from_proof : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-hash">hash</a> <span>&#45;&gt;</span> <a href="index.html#type-contents">contents</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-add_node_from_proof"><a href="#val-add_node_from_proof" class="anchor"></a><code><span class="keyword">val</span> add_node_from_proof : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-hash">hash</a> <span>&#45;&gt;</span> <a href="index.html#type-node">node</a> <span>&#45;&gt;</span> unit</code></dt><dt class="spec value" id="val-find_contents"><a href="#val-find_contents" class="anchor"></a><code><span class="keyword">val</span> find_contents : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-hash">hash</a> <span>&#45;&gt;</span> <span><a href="index.html#type-contents">contents</a> option</span></code></dt><dt class="spec value" id="val-find_node"><a href="#val-find_node" class="anchor"></a><code><span class="keyword">val</span> find_node : <a href="index.html#type-t">t</a> <span>&#45;&gt;</span> <a href="index.html#type-hash">hash</a> <span>&#45;&gt;</span> <span><a href="index.html#type-node">node</a> option</span></code></dt></dl></section></div></body></html>