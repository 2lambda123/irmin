<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Replayable_trace (irmin-bench.Irmin_traces.Trace_definitions.Replayable_trace)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">irmin-bench</a> &#x00BB; <a href="../../index.html">Irmin_traces</a> &#x00BB; <a href="../index.html">Trace_definitions</a> &#x00BB; Replayable_trace</nav><header class="odoc-preamble"><h1>Module <code><span>Trace_definitions.Replayable_trace</span></code></h1><p><code>Replayable_trace</code>, a trace of Tezos's interactions with Irmin.</p></header><nav class="odoc-toc"><ul><li><a href="#interleaved-contexts-and-commits">Interleaved Contexts and Commits</a></li></ul></nav><div class="odoc-content"><h4 id="interleaved-contexts-and-commits"><a href="#interleaved-contexts-and-commits" class="anchor"></a>Interleaved Contexts and Commits</h4><p>All the recorded operations in Tezos operate on (and create new) immutable records of type <code>context</code>. Most of the time, everything is linear (i.e. the input context to an operation is the latest output context), but there sometimes are several parallel chains of contexts, where all but one will end up being discarded.</p><p>Similarly to contexts, commits are not always linear, i.e. a checkout may choose a parent that is not the latest commit.</p><p>To solve this conundrum when replaying the trace, we need to remember all the <code>context_id -&gt; tree</code> and <code>trace commit hash -&gt; real commit hash</code> pairs to make sure an operation is operating on the right parent.</p><p>In the trace, the context indices and the commit hashes are 'scoped', meaning that they are tagged with a boolean information indicating if this is the very last occurence of that value in the trace. This way we can discard a recorded pair as soon as possible.</p><p>In practice, there is only 1 context and 1 commit in history, and sometimes 0 or 2, but the code is ready for more.</p><div class="odoc-spec"><div class="spec module" id="module-V0" class="anchored"><a href="#module-V0" class="anchor"></a><code><span><span class="keyword">module</span> <a href="V0/index.html">V0</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Latest" class="anchored"><a href="#module-Latest" class="anchor"></a><code><span><span class="keyword">module</span> Latest</span><span> = <a href="V0/index.html">V0</a></span></code></div></div><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="V0/index.html">Latest</a> <span class="keyword">end</span></span></code></summary><div class="odoc-spec"><div class="spec value" id="val-version" class="anchored"><a href="#val-version" class="anchor"></a><code><span><span class="keyword">val</span> version : int</span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-header" class="anchored"><a href="#type-header" class="anchor"></a><code><span><span class="keyword">type</span> header</span><span> = unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-header_t" class="anchored"><a href="#val-header_t" class="anchor"></a><code><span><span class="keyword">val</span> header_t : <span>unit <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-scope" class="anchored"><a href="#type-scope" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a scope</span></span><span> = <span><span class="type-var">'a</span> <a href="V0/index.html#type-scope">V0.scope</a></span></span><span> = </span></code><table><tr id="type-scope.Forget" class="anchored"><td class="def variant constructor"><a href="#type-scope.Forget" class="anchor"></a><code><span>| </span><span><span class="constructor">Forget</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr><tr id="type-scope.Keep" class="anchored"><td class="def variant constructor"><a href="#type-scope.Keep" class="anchor"></a><code><span>| </span><span><span class="constructor">Keep</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-scope_t" class="anchored"><a href="#val-scope_t" class="anchor"></a><code><span><span class="keyword">val</span> scope_t : <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Repr</span>.t</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-scope">scope</a></span> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-key" class="anchored"><a href="#type-key" class="anchor"></a><code><span><span class="keyword">type</span> key</span><span> = <span>string list</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-key_t" class="anchored"><a href="#val-key_t" class="anchor"></a><code><span><span class="keyword">val</span> key_t : <span><span>string list</span> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-hash" class="anchored"><a href="#type-hash" class="anchor"></a><code><span><span class="keyword">type</span> hash</span><span> = string</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-hash_t" class="anchored"><a href="#val-hash_t" class="anchor"></a><code><span><span class="keyword">val</span> hash_t : <span>string <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-message" class="anchored"><a href="#type-message" class="anchor"></a><code><span><span class="keyword">type</span> message</span><span> = string</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-message_t" class="anchored"><a href="#val-message_t" class="anchor"></a><code><span><span class="keyword">val</span> message_t : <span>string <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-context_id" class="anchored"><a href="#type-context_id" class="anchor"></a><code><span><span class="keyword">type</span> context_id</span><span> = int64</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-context_id_t" class="anchored"><a href="#val-context_id_t" class="anchor"></a><code><span><span class="keyword">val</span> context_id_t : <span>int64 <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-add" class="anchored"><a href="#type-add" class="anchor"></a><code><span><span class="keyword">type</span> add</span><span> = <a href="V0/index.html#type-add">V0.add</a></span><span> = </span><span>{</span></code><table><tr id="type-add.key" class="anchored"><td class="def record field"><a href="#type-add.key" class="anchor"></a><code><span>key : <a href="#type-key">key</a>;</span></code></td></tr><tr id="type-add.value" class="anchored"><td class="def record field"><a href="#type-add.value" class="anchor"></a><code><span>value : string;</span></code></td></tr><tr id="type-add.in_ctx_id" class="anchored"><td class="def record field"><a href="#type-add.in_ctx_id" class="anchor"></a><code><span>in_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></td></tr><tr id="type-add.out_ctx_id" class="anchored"><td class="def record field"><a href="#type-add.out_ctx_id" class="anchor"></a><code><span>out_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-add_t" class="anchored"><a href="#val-add_t" class="anchor"></a><code><span><span class="keyword">val</span> add_t : <span><a href="#type-add">add</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-copy" class="anchored"><a href="#type-copy" class="anchor"></a><code><span><span class="keyword">type</span> copy</span><span> = <a href="V0/index.html#type-copy">V0.copy</a></span><span> = </span><span>{</span></code><table><tr id="type-copy.key_src" class="anchored"><td class="def record field"><a href="#type-copy.key_src" class="anchor"></a><code><span>key_src : <a href="#type-key">key</a>;</span></code></td></tr><tr id="type-copy.key_dst" class="anchored"><td class="def record field"><a href="#type-copy.key_dst" class="anchor"></a><code><span>key_dst : <a href="#type-key">key</a>;</span></code></td></tr><tr id="type-copy.in_ctx_id" class="anchored"><td class="def record field"><a href="#type-copy.in_ctx_id" class="anchor"></a><code><span>in_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></td></tr><tr id="type-copy.out_ctx_id" class="anchored"><td class="def record field"><a href="#type-copy.out_ctx_id" class="anchor"></a><code><span>out_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-copy_t" class="anchored"><a href="#val-copy_t" class="anchor"></a><code><span><span class="keyword">val</span> copy_t : <span><a href="#type-copy">copy</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-commit" class="anchored"><a href="#type-commit" class="anchor"></a><code><span><span class="keyword">type</span> commit</span><span> = <a href="V0/index.html#type-commit">V0.commit</a></span><span> = </span><span>{</span></code><table><tr id="type-commit.hash" class="anchored"><td class="def record field"><a href="#type-commit.hash" class="anchor"></a><code><span>hash : <span><a href="#type-hash">hash</a> <a href="#type-scope">scope</a></span>;</span></code></td></tr><tr id="type-commit.date" class="anchored"><td class="def record field"><a href="#type-commit.date" class="anchor"></a><code><span>date : int64;</span></code></td></tr><tr id="type-commit.message" class="anchored"><td class="def record field"><a href="#type-commit.message" class="anchor"></a><code><span>message : <a href="#type-message">message</a>;</span></code></td></tr><tr id="type-commit.parents" class="anchored"><td class="def record field"><a href="#type-commit.parents" class="anchor"></a><code><span>parents : <span><span><a href="#type-hash">hash</a> <a href="#type-scope">scope</a></span> list</span>;</span></code></td></tr><tr id="type-commit.in_ctx_id" class="anchored"><td class="def record field"><a href="#type-commit.in_ctx_id" class="anchor"></a><code><span>in_ctx_id : <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-commit_t" class="anchored"><a href="#val-commit_t" class="anchor"></a><code><span><span class="keyword">val</span> commit_t : <span><a href="#type-commit">commit</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-row" class="anchored"><a href="#type-row" class="anchor"></a><code><span><span class="keyword">type</span> row</span><span> = <a href="V0/index.html#type-row">V0.row</a></span><span> = </span></code><table><tr id="type-row.Checkout" class="anchored"><td class="def variant constructor"><a href="#type-row.Checkout" class="anchor"></a><code><span>| </span><span><span class="constructor">Checkout</span> <span class="keyword">of</span> <span><a href="#type-hash">hash</a> <a href="#type-scope">scope</a></span> * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></td></tr><tr id="type-row.Add" class="anchored"><td class="def variant constructor"><a href="#type-row.Add" class="anchor"></a><code><span>| </span><span><span class="constructor">Add</span> <span class="keyword">of</span> <a href="#type-add">add</a></span></code></td></tr><tr id="type-row.Remove" class="anchored"><td class="def variant constructor"><a href="#type-row.Remove" class="anchor"></a><code><span>| </span><span><span class="constructor">Remove</span> <span class="keyword">of</span> <a href="#type-key">key</a> * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span> * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></td></tr><tr id="type-row.Copy" class="anchored"><td class="def variant constructor"><a href="#type-row.Copy" class="anchor"></a><code><span>| </span><span><span class="constructor">Copy</span> <span class="keyword">of</span> <a href="#type-copy">copy</a></span></code></td></tr><tr id="type-row.Find" class="anchored"><td class="def variant constructor"><a href="#type-row.Find" class="anchor"></a><code><span>| </span><span><span class="constructor">Find</span> <span class="keyword">of</span> <a href="#type-key">key</a> * bool * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></td></tr><tr id="type-row.Mem" class="anchored"><td class="def variant constructor"><a href="#type-row.Mem" class="anchor"></a><code><span>| </span><span><span class="constructor">Mem</span> <span class="keyword">of</span> <a href="#type-key">key</a> * bool * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></td></tr><tr id="type-row.Mem_tree" class="anchored"><td class="def variant constructor"><a href="#type-row.Mem_tree" class="anchor"></a><code><span>| </span><span><span class="constructor">Mem_tree</span> <span class="keyword">of</span> <a href="#type-key">key</a> * bool * <span><a href="#type-context_id">context_id</a> <a href="#type-scope">scope</a></span></span></code></td></tr><tr id="type-row.Commit" class="anchored"><td class="def variant constructor"><a href="#type-row.Commit" class="anchor"></a><code><span>| </span><span><span class="constructor">Commit</span> <span class="keyword">of</span> <a href="#type-commit">commit</a></span></code></td></tr></table></div></div><div class="odoc-spec"><div class="spec value" id="val-row_t" class="anchored"><a href="#val-row_t" class="anchor"></a><code><span><span class="keyword">val</span> row_t : <span><a href="#type-row">row</a> <span class="xref-unresolved">Repr</span>.t</span></span></code></div></div></details></div><div class="odoc-spec"><div class="spec value" id="val-decode_i32" class="anchored"><a href="#val-decode_i32" class="anchor"></a><code><span><span class="keyword">val</span> decode_i32 : <span>int32 <span class="xref-unresolved">Repr</span>.decode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-encode_i32" class="anchored"><a href="#val-encode_i32" class="anchor"></a><code><span><span class="keyword">val</span> encode_i32 : <span>int32 <span class="xref-unresolved">Repr</span>.encode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-encode_lheader" class="anchored"><a href="#val-encode_lheader" class="anchor"></a><code><span><span class="keyword">val</span> encode_lheader : <span>unit <span class="xref-unresolved">Repr</span>.encode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-encode_lrow" class="anchored"><a href="#val-encode_lrow" class="anchor"></a><code><span><span class="keyword">val</span> encode_lrow : <span><a href="V0/index.html#type-row">V0.row</a> <span class="xref-unresolved">Repr</span>.encode_bin</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-magic" class="anchored"><a href="#val-magic" class="anchor"></a><code><span><span class="keyword">val</span> magic : <span class="xref-unresolved">Irmin_traces__Trace_common.Magic.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-read_with_prefix_exn" class="anchored"><a href="#val-read_with_prefix_exn" class="anchor"></a><code><span><span class="keyword">val</span> read_with_prefix_exn : 
  <span><span>( <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>int <span class="xref-unresolved">Stdlib</span>.ref</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stdlib</span>.in_channel <span class="arrow">&#45;&gt;</span></span>
  <span class="type-var">'a</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-decoded_seq_of_encoded_chan_with_prefixes" class="anchored"><a href="#val-decoded_seq_of_encoded_chan_with_prefixes" class="anchor"></a><code><span><span class="keyword">val</span> decoded_seq_of_encoded_chan_with_prefixes : 
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Repr</span>.ty</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stdlib</span>.in_channel <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib__Seq</span>.node</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-open_reader" class="anchored"><a href="#val-open_reader" class="anchor"></a><code><span><span class="keyword">val</span> open_reader : <span>string <span class="arrow">&#45;&gt;</span></span> unit * <span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="V0/index.html#type-row">V0.row</a> <span class="xref-unresolved">Stdlib__Seq</span>.node</span> )</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-writer" class="anchored"><a href="#type-writer" class="anchor"></a><code><span><span class="keyword">type</span> writer</span><span> = </span><span>{</span></code><table><tr id="type-writer.path" class="anchored"><td class="def record field"><a href="#type-writer.path" class="anchor"></a><code><span>path : string;</span></code></td></tr><tr id="type-writer.channel" class="anchored"><td class="def record field"><a href="#type-writer.channel" class="anchor"></a><code><span>channel : <span class="xref-unresolved">Stdlib</span>.out_channel;</span></code></td></tr><tr id="type-writer.buffer" class="anchored"><td class="def record field"><a href="#type-writer.buffer" class="anchor"></a><code><span>buffer : <span class="xref-unresolved">Stdlib</span>.Buffer.t;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create_file" class="anchored"><a href="#val-create_file" class="anchor"></a><code><span><span class="keyword">val</span> create_file : <span>string <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="#type-writer">writer</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-append_row" class="anchored"><a href="#val-append_row" class="anchor"></a><code><span><span class="keyword">val</span> append_row : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="V0/index.html#type-row">V0.row</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-flush" class="anchored"><a href="#val-flush" class="anchor"></a><code><span><span class="keyword">val</span> flush : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-remove" class="anchored"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : <span><a href="#type-writer">writer</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div></div></body></html>